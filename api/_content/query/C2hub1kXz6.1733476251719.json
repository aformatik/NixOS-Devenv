{"_path":"/contrib/internals","_dir":"contrib","_draft":false,"_partial":false,"_locale":"","title":"Internals","description":"This page describes the internals of Codchi. For an overview of what Codchi is read What is Codchi?.","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"internals"},"children":[{"type":"text","value":"Internals"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This page describes the internals of Codchi. For an overview of what Codchi is read "},{"type":"element","tag":"a","props":{"href":"..//start/intro"},"children":[{"type":"text","value":"What is Codchi?"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"overview"},"children":[{"type":"text","value":"Overview"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Technically Codchi is just a \"driver\" for any NixOS module, such as:"}]},{"type":"element","tag":"pre","props":{"className":"language-nix shiki shiki-themes github-dark github-light","code":"{\n}\n","language":"nix","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;--shiki-default:#B31D28;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"That is just an empty NixOS module. To build this into a bootable machine without Codchi, you need to provide the hardware configuration (e.g. file system layout, boot loader, kernel, kernel module & options, desktop environment, ...). This can vary a lot from machine to machine, although virtual machines alleviate some of this."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With Codchi, however, the empty module above is a buildable machine configuration on Windows 10 & 11 and Linux:"}]},{"type":"element","tag":"pre","props":{"className":"language-bash shiki shiki-themes github-dark github-light","code":"codchi init empty-machine\ncodchi exec empty-machine -- uname -a\n> Linux nixos 6.6.32 #1-NixOS SMP PREEMPT_DYNAMIC Sat May 25 14:22:56 UTC 2024 x86_64 GNU/Linux\n","language":"bash","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"codchi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" init"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" empty-machine\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"codchi"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" exec"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" empty-machine"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":" --"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" uname"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":" -a\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E"},"children":[{"type":"text","value":" Linux nixos 6.6.32 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D"},"children":[{"type":"text","value":"#1-NixOS SMP PREEMPT_DYNAMIC Sat May 25 14:22:56 UTC 2024 x86_64 GNU/Linux\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This works because Codchi provides the hardware configuration, the drivers (i.e. WSL, LXD and so on), as well as host integration such as GUI and sound support, file system sharing between code machine and host, and much more:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Codchi architecture diagram","src":"/architecture.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The goal is to provide an easy to use NixOS driver for different platforms, where everything hardware related just works."}]},{"type":"element","tag":"h2","props":{"id":"capabilities"},"children":[{"type":"text","value":"Capabilities"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are the capabilities provided by Codchi. Every new driver must at least fully implement the \"must\" section."}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Category"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Capability"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Must / Should"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Windows + WSL"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"Linux + LXD"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Architecture"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Each code machine on a host uses a shared store accessible via "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nix-daemon"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Run full NixOS"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"SystemD working properly"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Run full NixOS"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Proper login shell, i.e. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"codchi exec"}]},{"type":"text","value":" creates a proper login shell with "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$DISPLAY"}]},{"type":"text","value":" set.  This is essential for the environment variables to be set correctly and for everything to start up correctly, including XDG autostart entries"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"❔"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"GUI & Sound: "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"codchi exec <MACHINE_NAME> -- nix run nixpkgs#xorg.xeyes"}]},{"type":"text","value":" must open xeyes on the host's desktop. X11 and wayland apps (with sound) must work."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"❔"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Tray icon: Codchi must be controllable through a tray icon on the host."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Shortcuts to each program in each code machine must be visible in the host's start menu, such that GUI and terminal applications can be started with a single click."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Terminal: Codchi must be integrated with the host's terminal, such that a terminal with a shell into each code machine can be opened from the codchi tray."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Secrets: A code machine can define secrets, which the codchi driver must store (preferably encrypted) on the host and provide it on code machine start."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Must"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"File system sharing: The file system of each code machine should be accessible from the host, e.g. as with WSL."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Should"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"✅"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"🚧 (Generally works through LXD, but UX can be improved)"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"GPU: If the host has a GPU driver installed, it should be usable from within a code machine."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Should"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"❔"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"❔"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"USB: USBs plugged into the host should be accessible from within a code machine."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Should"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"📝"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"📝"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Host Integration"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"SSL certificates: The hosts trust chain should be used inside a code machine, so that self signed certificates work (often used in enterprises)."}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Should"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"📝"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"📝"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Legend"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"✅ = Fully implemented and tested"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"❔ = Implemented, but untestet / buggy"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"🚧 = WIP"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"📝 = Planned"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"❌ = Not implemented"}]}]},{"type":"element","tag":"h2","props":{"id":"drivers"},"children":[{"type":"text","value":"Drivers"}]},{"type":"element","tag":"h3","props":{"id":"wsl"},"children":[{"type":"text","value":"WSL"}]},{"type":"element","tag":"h3","props":{"id":"lxd"},"children":[{"type":"text","value":"LXD"}]},{"type":"element","tag":"h3","props":{"id":"vm-export"},"children":[{"type":"text","value":"VM Export"}]},{"type":"element","tag":"h2","props":{"id":"guidelines"},"children":[{"type":"text","value":"Guidelines"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"reliable & reproducible"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"fast"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"easy to use"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Building on \"standards\" (NixOS modules)"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"overview","depth":2,"text":"Overview"},{"id":"capabilities","depth":2,"text":"Capabilities"},{"id":"drivers","depth":2,"text":"Drivers","children":[{"id":"wsl","depth":3,"text":"WSL"},{"id":"lxd","depth":3,"text":"LXD"},{"id":"vm-export","depth":3,"text":"VM Export"}]},{"id":"guidelines","depth":2,"text":"Guidelines"}]}},"_type":"markdown","_id":"content:4.contrib:internals.md","_source":"content","_file":"4.contrib/internals.md","_stem":"4.contrib/internals","_extension":"md"}